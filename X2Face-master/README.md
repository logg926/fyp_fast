This repository contains the code for [X2Face](http://www.robots.ox.ac.uk/~vgg/research/unsup_learn_watch_faces/x2face.html), presented at ECCV 2018.

<h1>Demo Files for Trained Models</h1>

The demo notebooks demonstrate the following:
- How to load the pre-trained models
- How to drive a face with another face in `./UnwrapMosaic/Face2Face_UnwrapMosaic.ipynb`
- How to edit the embedded face with a drawing or tattoo in `./UnwrapMosaic/Face2Face_UnwrapMosaic.ipynb`
- How to drive with pose in `./UnwrapMosaic/Pose2Face.ipynb`
- How to drive with audio in `./UnwrapMosiac/Audio2Face.ipynb`

**Update**: We have added updated code and installation instructions to run the demo notebooks with pytorch 0.4.1 and python 2.7 in the branch 'pytorch_0.4.1' and for pytorch 0.4.1 and python 3.7 in the branch 'py37_pytorch_0.4.1'.


To run the notebooks, you need:
- pytorch=0.2.0_4 
- torchvision
- PIL
- numpy
- matplotlib

It is **important** to use the right version of pytorch, as the defaults for sampling and some other things have changed in more recent versions of pytorch. In these cases, the pretrained models will not work properly.


Once the environment is set up, the pre-trained models can be downloaded from the [project page](http://www.robots.ox.ac.uk/~vgg/research/unsup_learn_watch_faces/x2face.html) and the model paths in the notebooks updated appropriately (this should simply require setting the BASE_MODEL_PATH in the notebook to the correct location).


If you find this useful in your work, please cite the paper appropriately.

<h1>Training</h1>

Training code requires:
- tensorboardX

To train a model yourself, we have given an example training file using only the photometric loss.
To run this:
- Go to the [website](http://www.robots.ox.ac.uk/~vgg/research/unsup_learn_watch_faces/x2face.html)
- In the data section download the images and training/testing splits
- Update the paths in ./UnwrapMosaic/VoxCelebData_withmask.py
- Run the code with `python train_model.py --results_folder $WHERE_TO_SAVE_TENSORBOARD_FILES --model_epoch_path $WHERETOSAVEMODELS`

(Note that this can be run with any version of pytorch -- it is merely important that you train/test with the same version.)


input
[[[142  67  46]
  [146  69  49]
  [152  75  57]
  ...
  [ 83  52  50]
  [ 91  61  59]
  [ 96  61  65]]

 [[125  60  38]
  [130  65  43]
  [137  71  49]
  ...
  [ 82  51  49]
  [ 91  60  58]
  [ 96  61  65]]

 [[101  57  30]
  [106  60  34]
  [115  68  42]
  ...
  [ 84  53  51]
  [ 92  61  59]
  [ 96  61  65]]

 ...

 [[ 55  29  14]
  [ 66  40  25]
  [ 82  56  39]
  ...
  [129  81  59]
  [126  78  56]
  [116  69  49]]

 [[ 32  11   6]
  [ 33  12   7]
  [ 37  14   8]
  ...
  [134  79  58]
  [131  76  55]
  [115  67  44]]

 [[ 26   5   0]
  [ 27   6   1]
  [ 28   5   0]
  ...
  [134  79  58]
  [131  76  55]
  [117  69  46]]]
  
output

[array([[[0.52312124, 0.30335775, 0.2106268 ],
        [0.4995895 , 0.31034157, 0.22406703],
        [0.4981715 , 0.309974  , 0.22369951],
        ...,
        [0.32246852, 0.20101309, 0.19316994],
        [0.32363322, 0.2022355 , 0.19439238],
        [0.33097762, 0.20987387, 0.20203073]],

       [[0.5225791 , 0.3274671 , 0.2412909 ],
        [0.5137834 , 0.3216147 , 0.235395  ],
        [0.49085414, 0.30645284, 0.21974777],
        ...,
        [0.33514428, 0.21401441, 0.20617127],
        [0.33235425, 0.21123399, 0.20339087],
        [0.31598473, 0.19441608, 0.18657292]],

       [[0.5038829 , 0.31417686, 0.22790231],
        [0.5144963 , 0.3222022 , 0.23599125],
        [0.5049772 , 0.31634057, 0.23011802],
        ...,
        [0.34317374, 0.22162274, 0.2142855 ],
        [0.34155434, 0.22009902, 0.21239246],
        [0.32452768, 0.20316948, 0.19532634]],

       ...,

       [[0.47403038, 0.2857951 , 0.19559899],
        [0.4714349 , 0.2831996 , 0.19300354],
        [0.46955657, 0.2813213 , 0.19112523],
        ...,
        [0.4970291 , 0.31271535, 0.23428398],
        [0.47289446, 0.29642385, 0.21407092],
        [0.47633764, 0.2998671 , 0.21751416]],

       [[0.46826282, 0.28002763, 0.18983151],
        [0.4682219 , 0.27998668, 0.18979059],
        [0.4620831 , 0.27384782, 0.18365175],
        ...,
        [0.5020373 , 0.313802  , 0.22672996],
        [0.500743  , 0.3147005 , 0.23263046],
        [0.47768956, 0.301219  , 0.21886605]],

       [[0.47551888, 0.2872836 , 0.19708748],
        [0.4452655 , 0.25703022, 0.16683413],
        [0.48468587, 0.29645056, 0.2062545 ],
        ...,
        [0.00791283, 0.00401856, 0.00220123],
        [0.10387825, 0.06664861, 0.04927478],
        [0.36187264, 0.1827181 , 0.10431859]]], dtype=float32), array([[[0.50873244, 0.30360943, 0.20777765],
        [0.47554705, 0.2902761 , 0.20322698],
        [0.4736212 , 0.2889862 , 0.20187369],
        ...,
        [0.31694448, 0.19537583, 0.18753271],
        [0.31722564, 0.19565703, 0.18781388],
        [0.32875806, 0.20763323, 0.1997901 ]],

       [[0.5183452 , 0.3245641 , 0.2383523 ],
        [0.4975524 , 0.30959967, 0.22332515],
        [0.47184777, 0.29250038, 0.20411405],
        ...,
        [0.33552927, 0.21455815, 0.20671505],
        [0.32977727, 0.20853373, 0.2006906 ],
        [0.31206283, 0.19049421, 0.18265106]],

       [[0.4910574 , 0.3040614 , 0.21778691],
        [0.49943203, 0.31124306, 0.22496854],
        [0.48176405, 0.29992276, 0.21264932],
        ...,
        [0.34281853, 0.22125337, 0.213843  ],
        [0.3406561 , 0.21911381, 0.21130525],
        [0.32292572, 0.20148933, 0.1936462 ]],

       ...,

       [[0.46980134, 0.28244805, 0.19195795],
        [0.47274026, 0.28694996, 0.19593889],
        [0.46333048, 0.27771115, 0.18671206],
        ...,
        [0.49319386, 0.3114437 , 0.23067495],
        [0.47776785, 0.3012973 , 0.21894434],
        [0.4887143 , 0.31223923, 0.2298908 ]],

       [[0.47539473, 0.28851286, 0.19786564],
        [0.4742269 , 0.2882076 , 0.19727284],
        [0.44700754, 0.25877222, 0.16857615],
        ...,
        [0.48802355, 0.29437894, 0.2058376 ],
        [0.5063789 , 0.31814355, 0.23205018],
        [0.48986372, 0.31342107, 0.23108116]],

       [[0.48076263, 0.29252738, 0.20233127],
        [0.4464575 , 0.25822216, 0.1680261 ],
        [0.48674905, 0.2985138 , 0.20831771],
        ...,
        [0.01199142, 0.00688538, 0.0047126 ],
        [0.01073266, 0.00630516, 0.004239  ],
        [0.29794562, 0.17758924, 0.12637375]]], dtype=float32), array([[[0.5227964 , 0.2965402 , 0.20391881],
        [0.53150034, 0.3211841 , 0.23797184],
        [0.5435727 , 0.32569584, 0.24305595],
        ...,
        [0.3085567 , 0.18698809, 0.17914493],
        [0.3102709 , 0.18870226, 0.18085912],
        [0.31293252, 0.19136386, 0.18352072]],

       [[0.54678524, 0.32697195, 0.24424383],
        [0.5428877 , 0.3256239 , 0.24258345],
        [0.5481101 , 0.32740292, 0.24501532],
        ...,
        [0.3082404 , 0.18667175, 0.17882863],
        [0.3078669 , 0.18629828, 0.17845511],
        [0.30909958, 0.18753096, 0.17968781]],

       [[0.5402844 , 0.3248108 , 0.24138366],
        [0.54483974, 0.32624587, 0.24313107],
        [0.5503443 , 0.3278111 , 0.24577598],
        ...,
        [0.31551236, 0.19394374, 0.18610059],
        [0.3097777 , 0.18820906, 0.18036592],
        [0.31678012, 0.19521144, 0.18736832]],

       ...,

       [[0.43367165, 0.24543637, 0.15524027],
        [0.43783188, 0.24959658, 0.15940046],
        [0.44541407, 0.25717875, 0.16698265],
        ...,
        [0.47657174, 0.2935087 , 0.2142546 ],
        [0.47934225, 0.30238616, 0.22006713],
        [0.4789767 , 0.2950895 , 0.21639706]],

       [[0.4535132 , 0.26527795, 0.17508185],
        [0.4373102 , 0.2490749 , 0.15887882],
        [0.43648708, 0.2482518 , 0.15805571],
        ...,
        [0.44833952, 0.26010415, 0.17361009],
        [0.44426188, 0.26271552, 0.16754155],
        [0.49216402, 0.30790362, 0.22941893]],

       [[0.47281328, 0.28457797, 0.1943819 ],
        [0.54283714, 0.3546018 , 0.2644057 ],
        [0.42688853, 0.23865327, 0.14845718],
        ...,
        [0.03121752, 0.0154258 , 0.00841798],
        [0.454162  , 0.27164   , 0.19211832],
        [0.29544246, 0.16056587, 0.10275245]]], dtype=float32), array([[[0.4484365 , 0.29193377, 0.18536632],
        [0.3497432 , 0.24387039, 0.12999621],
        [0.33190134, 0.2378934 , 0.12106799],
        ...,
        [0.301917  , 0.17651942, 0.1608608 ],
        [0.29847267, 0.176904  , 0.16627629],
        [0.31104082, 0.18947217, 0.18162903]],

       [[0.47630927, 0.30641368, 0.20982555],
        [0.41171545, 0.28242815, 0.17347498],
        [0.41653413, 0.28290161, 0.17500712],
        ...,
        [0.29807672, 0.17650808, 0.16685016],
        [0.3009418 , 0.17937315, 0.17127675],
        [0.30222237, 0.18065372, 0.17259975]],

       [[0.43056768, 0.2927865 , 0.18662427],
        [0.40796995, 0.2846185 , 0.17431657],
        [0.42651045, 0.28874534, 0.18269247],
        ...,
        [0.3010621 , 0.17905739, 0.16793583],
        [0.29837328, 0.17658006, 0.16471875],
        [0.29903442, 0.17693332, 0.16535087]],

       ...,

       [[0.4533707 , 0.2825079 , 0.18557268],
        [0.53840375, 0.34319997, 0.26874515],
        [0.45755523, 0.29196486, 0.228349  ],
        ...,
        [0.4706922 , 0.29378295, 0.21143   ],
        [0.4875068 , 0.3106273 , 0.22868326],
        [0.50411254, 0.31732208, 0.2376984 ]],

       [[0.46873498, 0.282669  , 0.19138135],
        [0.48947108, 0.3075046 , 0.21744181],
        [0.49550906, 0.31739146, 0.22635762],
        ...,
        [0.47573557, 0.28750026, 0.20122574],
        [0.5604451 , 0.35923985, 0.24330066],
        [0.46940938, 0.2867137 , 0.20657554]],

       [[0.45938867, 0.27115342, 0.18095732],
        [0.5537043 , 0.36546907, 0.27527297],
        [0.46413437, 0.27589908, 0.18570301],
        ...,
        [0.47049716, 0.28378463, 0.19909492],
        [0.47337204, 0.29056352, 0.20732734],
        [0.        , 0.        , 0.        ]]], dtype=float32)]